=== JEPXスポット市場取引結果取込

==== 概要

[.lead]
JEPXのサイトよりスポット市場取引結果のcsvを取得し、関連テーブルへの登録・更新を行う

[plantuml]
--
cloud JEPX {
  file "スポット市場取引結果ファイル" as input
}
rectangle SCM {
  (JEPXスポット市場取引結果取込) as (main)
  database "JEPXスポット市場取引結果" as dbmain
  database "JEPXスポット市場取引JEPXスポット市場取引結果エリア別" as dbsub
}

input --> main : input
main --> dbmain : output
main --> dbsub : output
--

===== I/O

|======================================
| 名称                                                 | 物理名                                           | 種類 | I/O種別 | 備考
| スポット市場取引結果ファイル                         | http://www.jepx.org/market/excel/spot_[年度].csv | CSV  | IN      |
| JEPXスポット市場取引結果                             | jepx_spot_trades                                 | DB   | OUT     |
| JEPXスポット市場取引JEPXスポット市場取引結果エリア別 | jepx_spot_trade_area_data                        | DB   | OUT     |
|======================================

===== パラメータ

|======================================
| 名称 | 物理名 | 必須 | 備考
| 年度 | YEAR   | ×    |
|======================================

<<<

==== 処理詳細

===== パラメータチェック

パラメータで年度を指定した場合は、その年度のファイルを取得し、STEP 2の取込処理を行う。
年度指定が無い場合は、現在の日付より年度を求める。年度は、現在日付の年をYとした場合、1月1日～3月31日までが(Y-1)年度(ex.2018/02/23ならば2017年度)、4月1日～12月31日までが、(Y)年度になる。

なお「α確報値×スポット・時間前平均価格(円/kWh)」(以下確報値)については、CSVに値が入るまでに、1ヶ月～2ヶ月程度かかるため、4月1日をもって年度を切り替えると前年度の確報値の取り込みが漏れてしまう。そのため、以下の条件を**全て**満たす場合は、STEP 2の取込処理を前年度分と当年度分の両方に対して実施する。

* パラメータで年度指定がないこと
* 処理日が4月1日～5月31日までの期間に含まれること
* DBを検索し前年度の3月31日(=同年の3月31日)の確報値に値が無いこと

===== 取込処理

. JEPXのサイトより指定された年度のファイルをダウンロードする
. ダウンロードしたCSVを読みこみ、DBの対応する項目に保存する。
** この際、同一日時のデータが存在しない場合は、登録し、同一日時のデータが存在する場合は、更新する。エリアについては、適宜コードへの置き換えを行うこと。

<<<